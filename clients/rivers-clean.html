<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>River Networks - Clean View</title>
    
    <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet">
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        
        .info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            color: #666;
            z-index: 1;
        }
        
        .maplibregl-popup-content {
            padding: 10px;
            border-radius: 4px;
        }
        
        .maplibregl-popup-content h4 {
            margin: 0 0 6px 0;
            color: #1e40af;
            font-size: 14px;
        }
        
        .maplibregl-popup-content p {
            margin: 3px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="info">
        Rivers of Western United States • NHDPlus HR • Click for details
    </div>

    <script>
        // Configuration
        const TILE_SERVER = 'http://localhost:7800/public.merged_rivers/{z}/{x}/{y}.pbf';
        
        // Initialize map with clean white background
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'rivers': {
                        type: 'vector',
                        tiles: [TILE_SERVER],
                        minzoom: 0,
                        maxzoom: 14
                    }
                },
                layers: [
                    // Very subtle off-white background to match reference
                    {
                        id: 'background',
                        type: 'background',
                        paint: {
                            'background-color': '#f8f9fa'
                        }
                    },
                    // Rivers - varying width by Strahler order
                    {
                        id: 'rivers',
                        type: 'line',
                        source: 'rivers',
                        'source-layer': 'public.merged_rivers',
                        layout: {
                            // Round caps and joins for smooth lines
                            'line-cap': 'round',
                            'line-join': 'round'
                        },
                        paint: {
                            // Lighter blue to match reference image
                            'line-color': '#4169E1',
                            // Width based on Strahler order with proper exponential scaling
                            'line-width': [
                                'interpolate',
                                ['exponential', 2],
                                ['zoom'],
                                4, [
                                    'case',
                                    ['>=', ['get', 'strahler'], 7], 2.5,
                                    ['>=', ['get', 'strahler'], 6], 1.8,
                                    ['>=', ['get', 'strahler'], 5], 1.2,
                                    ['>=', ['get', 'strahler'], 4], 0.8,
                                    ['>=', ['get', 'strahler'], 3], 0.5,
                                    ['>=', ['get', 'strahler'], 2], 0.3,
                                    0.2
                                ],
                                8, [
                                    'case',
                                    ['>=', ['get', 'strahler'], 7], 6,
                                    ['>=', ['get', 'strahler'], 6], 4.5,
                                    ['>=', ['get', 'strahler'], 5], 3,
                                    ['>=', ['get', 'strahler'], 4], 2,
                                    ['>=', ['get', 'strahler'], 3], 1.2,
                                    ['>=', ['get', 'strahler'], 2], 0.7,
                                    0.4
                                ],
                                12, [
                                    'case',
                                    ['>=', ['get', 'strahler'], 7], 10,
                                    ['>=', ['get', 'strahler'], 6], 7,
                                    ['>=', ['get', 'strahler'], 5], 5,
                                    ['>=', ['get', 'strahler'], 4], 3.5,
                                    ['>=', ['get', 'strahler'], 3], 2,
                                    ['>=', ['get', 'strahler'], 2], 1.2,
                                    0.8
                                ]
                            ],
                            'line-opacity': 0.75
                        }
                    }
                ]
            },
            center: [-122.49, 40.82], // Northern California
            zoom: 7,
            maxZoom: 14
        });
        
        // Add navigation controls
        map.addControl(new maplibregl.NavigationControl(), 'top-right');
        
        // Change cursor on hover
        map.on('mouseenter', 'rivers', () => {
            map.getCanvas().style.cursor = 'pointer';
        });
        
        map.on('mouseleave', 'rivers', () => {
            map.getCanvas().style.cursor = '';
        });
        
        // Click to show river info
        map.on('click', 'rivers', (e) => {
            const props = e.features[0].properties;
            const name = props.name || 'Unnamed waterway';
            
            new maplibregl.Popup({ offset: 10 })
                .setLngLat(e.lngLat)
                .setHTML(`
                    <h4>${name}</h4>
                    <p><strong>Stream Order:</strong> ${props.strahler}</p>
                    <p><strong>Watershed:</strong> ${props.huc8}</p>
                `)
                .addTo(map);
        });
        
        // URL hash for sharing
        map.on('moveend', () => {
            const center = map.getCenter();
            const zoom = map.getZoom();
            window.location.hash = `#${zoom.toFixed(2)}/${center.lat.toFixed(4)}/${center.lng.toFixed(4)}`;
        });
        
        // Restore from URL hash
        if (window.location.hash) {
            const hash = window.location.hash.substring(1);
            const parts = hash.split('/');
            if (parts.length === 3) {
                map.setZoom(parseFloat(parts[0]));
                map.setCenter([parseFloat(parts[2]), parseFloat(parts[1])]);
            }
        }
        
        console.log('River network map loaded');
        console.log('Zoom out to see dendritic patterns across the Western US');
    </script>
</body>
</html>